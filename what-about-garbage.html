<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>What About Garbage? | 图解我的私房菜</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="What About Garbage?" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="If you’ve been following the news, you’ll have noticed that yesterday Composer got a bit of a speed boost. And by “bit of a speed boost”, we’re talking between 50% and 90% reduction in runtime depending on the complexity of the dependencies. But how did the fix work? And should you make the same sort of change to your projects? For those of you who want the TL/DR answer: the answer is no you shouldn’t." />
<meta property="og:description" content="If you’ve been following the news, you’ll have noticed that yesterday Composer got a bit of a speed boost. And by “bit of a speed boost”, we’re talking between 50% and 90% reduction in runtime depending on the complexity of the dependencies. But how did the fix work? And should you make the same sort of change to your projects? For those of you who want the TL/DR answer: the answer is no you shouldn’t." />
<link rel="canonical" href="/what-about-garbage" />
<meta property="og:url" content="/what-about-garbage" />
<meta property="og:site_name" content="图解我的私房菜" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-12-03T00:00:00+00:00" />
<script type="application/ld+json">
{"description":"If you’ve been following the news, you’ll have noticed that yesterday Composer got a bit of a speed boost. And by “bit of a speed boost”, we’re talking between 50% and 90% reduction in runtime depending on the complexity of the dependencies. But how did the fix work? And should you make the same sort of change to your projects? For those of you who want the TL/DR answer: the answer is no you shouldn’t.","@type":"BlogPosting","url":"/what-about-garbage","headline":"What About Garbage?","dateModified":"2014-12-03T00:00:00+00:00","datePublished":"2014-12-03T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/what-about-garbage"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="/what-about-garbage">
  <link rel="alternate" type="application/rss+xml" title="图解我的私房菜"
    href="/feed.xml">
  <link rel="stylesheet" href="/assets/css/prism.css">
  <link rel="stylesheet" href="/assets/css/prism-line-numbers.css">
  
  
  
</head>
<body class="blog">
<header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href="/">
				图解我的私房菜
			</a>
			
			<div class='menu'>
				<ul class='h-list'>
					
					<li>
							<a class='flat-box nav-home' href='/'>
								
								首页
							</a>
					</li>
					
					<li>
							<a class='flat-box nav-archives' href='/archives/'>
								
								时光机
							</a>
					</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			

			

			
			<div class="m_search">
				<form name="searchform" class="form u-search-form">
					<input type="text" class="input u-search-input" placeholder="Search" />
					<span class="icon icon-search"></span>
				</form>
			</div>
			
			<ul class='switcher h-list'>
				
				<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a>
				</li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span
							class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a>
				</li>
				<li class='s-toc'><a href='javascript:void(0)'><span
							class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
		
		
			<a href="/" class="nav-home nav">
				首页
			</a>
			
			
			
		
		
			<a href="/archives/" class="nav-archives nav">
				时光机
			</a>
			
			
			
	</nav>
</aside><div class="l_body">
        <div class='container clearfix'>
            <div class='l_main'>
                <article id="post-<test34"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title"><a href="/what-about-garbage">
    	What About Garbage?
    </a>
  </h2>
	<time>
		<span class="icon-calendar"></span> 	2014-12-03
	</time>
 
	</section>  
		<section class="toc-wrapper">
      <div class="nav">
        <span>Table Of Contents</span>
	  </div>
	   <div class="js-toc"  ></div>
	   
	</section> 
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<p>If you’ve been following the news, you’ll have noticed that yesterday <a href="https://getcomposer.org/">Composer</a> got a <a href="https://github.com/composer/composer/commit/ac676f47f7bbc619678a29deae097b6b0710b799">bit of a speed boost</a>. And by “bit of a speed boost”, we’re talking between 50% and 90% reduction in runtime depending on the complexity of the dependencies. But how did the fix work? And should you make the same sort of change to your projects? For those of you who want the TL/DR answer: the answer is <em>no</em> you shouldn’t.</p>

<!--more-->
<h2 id="the-change">The Change</h2>

<p>The change was adding single line of code:</p>

<pre><code class="language-php">    public function run()
    {   
+       gc_disable();
</code></pre>
<p>That single line of code added caused literally a 90% reduction in runtime. Why?</p>

<p>Well, according to <a href="http://php.net/gc_disable">the docs on <code>gc_disable()</code></a>:</p>

<blockquote>
  <p>Deactivates the circular reference collector, setting <code>zend.enable_gc</code> to <code>0</code>.</p>
</blockquote>

<p>So there you have it. By disabling the collector, speed improved!!!</p>

<p>Yeah, like I was going to leave it at that.</p>

<h2 id="garbage-and-php">Garbage And PHP</h2>

<p><strong>NOTE:</strong> This all assumes PHP 5.X. The concepts of this will still be valid in 7, but some of the details may be changed.</p>

<p>PHP uses reference counted variables. That means that copying a variable doesn’t actually copy it internally.</p>

<pre><code class="language-php">$a = "this is a long string";
$b = $a;
</code></pre>

<p>That results in two “pointers” to the same value. Let’s go into C to look at the representation of this.</p>

<p>It’s called internally a <a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend.h#334"><code>zval</code></a> (<strong>Z</strong>end <strong>Val</strong>ue). And it looks like this:</p>

<pre><code class="language-c">struct _zval_struct {
    zvalue_value value;
    zend_uint refcount__gc;
    zend_uchar type;
    zend_uchar is_ref__gc;
};
</code></pre>

<p>Let’s imagine that this is a PHP class:</p>

<pre><code class="language-php">class Zval {
    public $value;
    public $type;
    public $refcount = 1;
    public $is_ref = false;
}
</code></pre>

<p>Value is just another data structure that can hold all of the possible values that can be stored. Type indicates which type the value is (defined by the <a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend.h#581"><code>IS_\*</code> definitions</a>. The two interesting values are <code>refcount</code> and <code>is_ref</code>. Let’s talk about them…</p>

<p>So because values aren’t copied internally when you copy a variable, there needs to be a mechanism to make sure that changes go to the correct variable. This mechanism is called <a href="http://en.wikipedia.org/wiki/Copy-on-write">Copy-On-Write</a>.</p>

<p>Basically, if you edit a variable who’s value is referenced by more than one variable, it will copy the variable right before modifying it. This makes far more sense with an example, so let’s look at one:</p>

<pre><code class="language-php">$a = "this is a long string";
</code></pre>

<p>Will result in a variable <code>a</code> in a hash table, pointing to a <code>zval</code> instance with a value of string. We can imagine this:</p>

<pre><code class="language-php">$scope['a'] = new Zval();
$scope['a']-&gt;type = IS_STRING;
$scope['a']-&gt;value = "this is a long string";
</code></pre>

<p>Right now, we don’t need any of those other variables. So far, everything is happy.</p>

<p>But what happens when we copy it?</p>

<pre><code class="language-php">$b = $a;
</code></pre>

<p>Now what? Well, we “point” to the same value:</p>

<pre><code class="language-php">function copy($scope, $from, $to) {
    $scope[$to] = $scope[$from];
}
</code></pre>

<p>And thanks to object references, we aren’t duplicating anything! Awesome!</p>

<p>But what happens if we now change one of them? Well, we change both. And we have no way of detecting those changes. So we need to add one.</p>

<p>We need to add another line to that “assignment” (well, two, but we’ll get to the second one in a bit):</p>

<pre><code class="language-php">function copy($scope, $from, $to) {
    $scope[$to] = $scope[$from];
    $scope[$to]-&gt;refcount++;
}
</code></pre>

<p>Great! Now we can detect how many references there are!</p>

<p>Now what?</p>

<p>Let’s now modify one of them. Let’s change <code>$a</code> to another value:</p>

<pre><code class="language-php">$a = "something else";
</code></pre>

<p>Internally, we’d have a check like this:</p>

<pre><code class="language-php">function write($scope, $var, $value) {
    if ($scope[$var]-&gt;refcount &gt; 1) {
        // reduce the refcount of the original
        $scope[$var]-&gt;refcount--;
        // actually copy the value
        $scope[$var] = clone $scope[$var];
        // reset the refcount to 1
        $scope[$var]-&gt;refcount = 1;
    }
    $scope[$var]-&gt;value = $value;
}
</code></pre>

<p>So far so good.</p>

<p>There are two more things we need to talk about. The first is references:</p>

<pre><code class="language-php">$b = &amp;$a;
</code></pre>

<p>What happens here, is that we <em>want</em> them to share the same value. So instead of just increasing refcount, we also need to set <code>is_ref</code> to true:</p>

<pre><code class="language-php">function makeRef($scope, $from, $to) {
    if (
        $scope[$from]-&gt;refcount &gt; 1
        &amp;&amp; !$scope[$from]-&gt;is_ref
    ) {
        // separate the old one
        $scope[$from]-&gt;refcount--;
        $scope[$from] = clone $scope[$from];
        $scope[$from]-&gt;refcount = 1;
    }
    $scope[$from]-&gt;is_ref = true;
    $scope[$from]-&gt;refcount++;
    $scope[$to] = $scope[$from];
}
</code></pre>

<p>Now, we need to change our write function to not copy if the variable is a reference:</p>

<pre><code class="language-php">function write($scope, $var, $value) {
    if (
        $scope[$var]-&gt;refcount &gt; 1
        &amp;&amp; !$scope[$var]-&gt;is_ref
    ) {
        // reduce the refcount of the original
        $scope[$var]-&gt;refcount--;
        // actually copy the value
        $scope[$var] = clone $scope[$var];
        // reset the refcount to 1
        $scope[$var]-&gt;refcount = 1;
    }
    $scope[$var]-&gt;value = $value;
}
</code></pre>

<p>Now, any writes will be directed to the correct variable. But we still have a problem. We need to fix our <code>copy</code> function, becuase we may accidentally copy a reference!</p>

<pre><code class="language-php">function copy($scope, $from, $to) {
    if (
        $scope[$from]-&gt;refcount &gt; 1
        &amp;&amp; $scope[$var]-&gt;is_ref
    ) {
        // Separate it if it is a reference
        $scope[$to] = clone $scope[$from];
        $scope[$to]-&gt;is_ref = false;
        $scope[$to]-&gt;refcount = 1;
    } else {
        $scope[$to] = $scope[$from];
        $scope[$to]-&gt;refcount++;
    }
}
</code></pre>

<p>If you notice, there’s a fair bit of duplication in there.</p>

<p>Internally, PHP represents these operations as:</p>

<ul>
  <li>
    <p><a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend.h#779"><code>SEPARATE_ZVAL(zval)</code></a></p>

    <p>Always copy the value. This is used when you want to explicitly disable copy-on-write.</p>
  </li>
  <li>
    <p><a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend.h#791"><code>SEPARATE_ZVAL_IF_NOT_REF(zval)</code></a></p>

    <p>Copy the value if it’s not a reference. This is what you would call when you’re writing a variable.</p>
  </li>
  <li>
    <p><a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend.h#796"><code>SEPARATE_ZVAL_TO_MAKE_IS_REF(zval)</code></a></p>

    <p>Copy the value if it’s not a reference. This is what you would call to make a variable a reference.</p>
  </li>
</ul>

<h2 id="the-point">The Point</h2>

<p>So variables are disconnected from values. This means that deleting a variable (via <code>unset()</code> or falling out of scope) doesn’t delete its value.</p>

<p>So instead, it decrements the refcount (since there is one less variable pointing to it).</p>

<p>Then, it checks to see if the current refcount is <code>0</code>. If it is, it can safely delete the value, since there is nothing else pointing to it.</p>

<p>This happens internally in <code>zval_ptr_dtor()</code>, which is implemented via <a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend_execute.h#74"><code>i_zval_ptr_dtor</code></a>:</p>

<pre><code class="language-c">static zend_always_inline void i_zval_ptr_dtor(zval *zval_ptr ZEND_FILE_LINE_DC TSRMLS_DC)
{
    if (!Z_DELREF_P(zval_ptr)) {
        ZEND_ASSERT(zval_ptr != &amp;EG(uninitialized_zval));
        GC_REMOVE_ZVAL_FROM_BUFFER(zval_ptr);
        zval_dtor(zval_ptr);
        efree_rel(zval_ptr);
    } else {
        if (Z_REFCOUNT_P(zval_ptr) == 1) {
            Z_UNSET_ISREF_P(zval_ptr);
        }

        GC_ZVAL_CHECK_POSSIBLE_ROOT(zval_ptr);
    }
}
</code></pre>

<p>Note that <code>Z_DELREF_P(zval_ptr)</code> is really just a helper that does nothing more than <code>--(zval_ptr-&gt;refcount)</code>.</p>

<p>There are a few interesting things in here. The first branch happens when the refcount hits zero (meaning there are no variables pointing to it). Once it does, it removes the value from the garbage collector, runs a destructor function, and frees (deletes) it.</p>

<p>The other branch is where things get really interesting. First, it forces the <code>is_ref</code> flag to <code>false</code> if the refcount is <code>1</code> (since it’s impossible to reference yourself). This is just an optimization.</p>

<p>But the next line is interesting. <code>GC_ZVAL_CHECK_POSSIBLE_ROOT</code>. What does that do? Well, to understand that, let’s talk about garbage collection.</p>

<h2 id="two-types-of-garbage-collection">Two Types Of Garbage Collection</h2>

<p>What we’ve described up until this point is known as <a href="http://en.wikipedia.org/wiki/Reference_counting">Reference Counting</a> and is a form of garbage collection. Any time the number of references to a value hits <code>0</code>, we know we can safely delete it.</p>

<p>The vast majority of situations will be covered completely by this form of GC. This was all PHP had until 5.3.0.</p>

<p>There is a slight problem with it though. It doesn’t handle circular references at all.</p>

<p>Imagine the following code:</p>

<pre><code class="language-php">function foo() {
    $a = array();
    $b = array();
    $a['b'] = &amp;$b;
    $b['a'] = &amp;$a;
}
</code></pre>

<p>Internally we have two values created (<code>a</code> and <code>b</code>). But each value has two pointers to it. One for the variable, and one for the array index.</p>

<p>If we were to <code>var_dump($a)</code>, we’d see:</p>

<pre><code class="language-php">array(1) {
  ["b"]=&gt;
  &amp;array(1) {
    ["a"]=&gt;
    &amp;array(1) {
      ["b"]=&gt;
      *RECURSION*
    }
  }
}
</code></pre>

<p>The reason is that we now have what’s known as a <a href="http://en.wikipedia.org/wiki/Circular_reference">Circular Reference</a>.</p>

<p>The problem with it is that with Reference Counting alone, we can never collect that memory again (unless you manually unset one of the array keys).</p>

<p>The reason is that after we delete the two variables (<code>$a</code> and <code>$b</code>) when we leave the function scope, we still have variables pointing to each value (their array keys).</p>

<p>So we would need some way to detect that.</p>

<h2 id="cyclic-garbage-collection">Cyclic Garbage Collection</h2>

<p>Enter something called a cyclic garbage collector.</p>

<p>Basically, this is a function which will try to detect those circular references. We call it cyclic, because it’s generalized to not just handle circular references, but handle any kind of <a href="http://en.wikipedia.org/wiki/Cycle_%28graph_theory%29">Cycle</a>.</p>

<p>So how does it work?</p>

<h3 id="collecting-cycles">Collecting Cycles</h3>

<p>I’m going to describe this backwards. I’m going to talk about how it identifies roots later. From here, let’s talk about how it processes those roots to collect free memory.</p>

<p>PHP has a list (a linked-list) of possible “roots”. These are values that have had their refcount decremented (and hence could be part of a cycle).</p>

<p>Internally, the collector uses a “color code” system to identify states for specific values.</p>

<ul>
  <li><strong>Black</strong> - A normal variable, nothing special</li>
  <li><strong>Purple</strong> - A normal variable, but has been marked as a “possible root”, meaning that it may be part of a cycle that’s no longer reachable</li>
  <li><strong>Grey</strong> - In process variable, nothing special</li>
  <li><strong>White</strong> - In process variable, but can be freed.</li>
</ul>

<p>They are nothing more than bit flags, but the color system is “easier” to understand.</p>

<p>So when we “collect cycles” (via a few mechanisms, but <a href="http://php.net/manual/en/function.gc-collect-cycles.php"><code>gc_collect_cycles()</code></a> as well), we are going to iterate over these roots.</p>

<p>The internal <a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend_gc.c#gc_collect_cycles"><code>gc_collect_cycles()</code></a> function does a bunch of things. But there are three lines of critical importance:</p>

<pre><code class="language-c">gc_mark_roots(TSRMLS_C);
gc_scan_roots(TSRMLS_C);
gc_collect_roots(TSRMLS_C);
</code></pre>

<p>It’s a <a href="http://www.brpreiss.com/books/opus5/html/page424.html">“mark and sweep”</a> algorithm.</p>

<p>So we start off with our table:</p>

<p><img src="http://2.bp.blogspot.com/-v14QXmkxfxw/VH5RfGgiOpI/AAAAAAAAPXo/RkM8W_hNoGs/s320/gc_inital.png" alt="Roots and values" /></p>

<p>Here, you see that we have 4 values being tracked. Two are on the root buffer (and are purple, both with refcount 1), and two are not (and are black, one with refcount 1 and one with 2). The second object referencing value 4 is not shown (because we can’t get to it, that’s the point).</p>

<ol>
  <li>
    <p><a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend_gc.c#gc_mark_roots">Mark Roots</a></p>

    <p>First, it iterates across all of the roots. For each root, it <a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend_gc.c#zobj_mark_grey">sets the color to grey</a> (in process).</p>

    <p>But when it marks it as grey, it then goes deeper into that variable. It iterates through all of the children of that variable, and attempts to mark them as grey as well (if they are not already grey). But when it reaches that child, it reduces the refcount.</p>

    <p>So it does a depth-first search through all of the roots and their children, reducing the refcount as it goes (being sure to only reduce it once).</p>

    <p>This is basically the same concept as “if this root were to be removed, what would happen to the rest of the children”.</p>

    <p>It does this for the entire variable graph.</p>

    <p><img src="http://4.bp.blogspot.com/-HD4BmFCmIl0/VH5RfLyhvAI/AAAAAAAAPXI/A-7I9B8FTmA/s320/gc_mark_roots.png" alt="Mark Them Grey" /></p>

    <p>As you can see, all of the refcounts are decremented by one.</p>
  </li>
  <li>
    <p><a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend_gc.c#gc_scan_roots">Scan Roots</a></p>

    <p>At this point, it will do another depth-first search through all of the roots and their children. This time, it checks to see the refcount (assuming that the color is “grey” - in-progress).</p>

    <p>If the refcount is more than 0, it means that there must exist another reference to it. So it’s <a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend_gc.c#zval_scan">set to black</a> (meaning that it’s a normal variable) and every child is also set to black.</p>

    <p>If the refcount is 0, then that means that there’s a cycle. The value is set to white meaning it can be marked for removal.</p>

    <p>After the scan, all of the colors should be either black or white. Meaning still have references, or don’t.</p>

    <p><img src="http://3.bp.blogspot.com/-65QhaIUH-jw/VH5RfyeWg0I/AAAAAAAAPXY/gBHCBP0plbE/s320/gc_scan_roots.png" alt="Scan The Roots" /></p>

    <p>In this case, both values 1 and 2 are marked for collection.</p>
  </li>
  <li>
    <p><a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend_gc.c#gc_collect_roots">Collect Roots</a></p>

    <p>Yet another depth-first search through all of the roots and their children. Except this time, any white values are collected and freed.</p>

    <p>Non-white values are skipped (nothing happens to them).</p>

    <p><img src="http://2.bp.blogspot.com/-pdmWyHPYJXE/VH5RfA0Fm7I/AAAAAAAAPXM/gSuI1FMkAyM/s320/gc_collect_roots.png" alt="Collect The Roots" /></p>

    <p>As you can see, values 1 and 2 are gone.</p>
  </li>
</ol>

<p>Notice what happened there. We did a depth-first search through every value in the graph. But not only that, we did three.</p>

<p>You may spot something that could be fixed. You could say, why not combine the scan and collect phases into one pass?</p>

<p>Well, there’s a problem. If you had a complex relationship, where there are more than 2 elements in the graph, you wouldn’t be able to do that:</p>

<p><img src="http://1.bp.blogspot.com/-cgGDLUy9UiA/VH5Rfv6JewI/AAAAAAAAPXQ/-qEvNbiRubc/s320/gc_mid_scan.png" alt="mid_scan" /></p>

<p>This is mid-scan. We’ve already marked value 1 and 2 as white, since their refcount is 0. But then we come to value 5. Its refcount is 1, meaning there’s still a reference to it.</p>

<p>So now, we’re at a dilema. If we freed as part of scan, we’d have deleted information we need. But in this case, we can just search right back and mark value 2 as black (since a parent is black). So the overall graph would wind up black in the end.</p>

<p>So this is not a cheap thing.</p>

<p>Collecting cycles takes <strong>a lot</strong> of power to do. It is especially expensive on object graphs that are deep, since it needs to visit every object.</p>

<p>Suffice it to say it’s an expensive operation.</p>

<p>Thankfully it happens extremely infrequently in normal applications. And when it happens, it’s likely because you’re allocating a lot of objects, and hence can have a lot of cycles built up (and hence a chance to save a lot of memory).</p>

<p>So that’s how we collect roots. Let’s talk about how we find them.</p>

<h3 id="finding-possible-roots">Finding Possible Roots</h3>

<p>Well if you remember back to the <code>zval_ptr_dtor</code> call, there was a call to <code>GC_ZVAL_CHECK_POSSIBLE_ROOT</code> at the end. That macro proxies to <a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend_gc.h#gc_zval_check_possible_root"><code>gc_zval_check_possible_root()</code></a>:</p>

<pre><code class="language-c">static zend_always_inline void gc_zval_check_possible_root(zval *z TSRMLS_DC)
{
    if (z-&gt;type == IS_ARRAY || z-&gt;type == IS_OBJECT) {
        gc_zval_possible_root(z TSRMLS_CC);
    }
}
</code></pre>

<p>So basically, if the type is complex (can have child variables), then say that it’s a possible root (meaning that it may be the source of a cycle). So it runs a <a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend_gc.c#130">root algorithm</a>.</p>

<p>A lot is going on here, but basically it boils down to a few basic steps:</p>

<ol>
  <li>
    <p>Check to see if it’s already a root</p>

    <pre><code class="language-c">if (GC_ZVAL_GET_COLOR(zv) != GC_PURPLE) {
</code></pre>

    <p>So this if statement basically says “if this value is already a root, skip it”.</p>
  </li>
  <li>
    <p>If it’s not a root, make it one.</p>

    <p>To make it a root, first we set the color to Purple:</p>

    <pre><code class="language-c">GC_ZVAL_SET_PURPLE(zv);
</code></pre>

    <p>This is just really house-keeping, and doesn’t really effect anything.</p>

    <p>Then, we need to check to see if we’ve already stored this in the list of possible roots:</p>

    <pre><code class="language-c">if (!GC_ZVAL_ADDRESS(zv)) {
</code></pre>

    <p>This again is house-keeping. In practice, we can ignore this part since it should never get out of sync with the Purple flag. This is here as protection.</p>

    <p>The next bit is where interesting things start happening:</p>

    <p>So the GC uses a linked list for the buffer of possible roots. So to add a root, we need to get the next unused item (the head of the linked list).</p>

    <p>I’ll explain inline:</p>

    <pre><code class="language-c">gc_root_buffer *newRoot = GC_G(unused);
    
if (newRoot) {
    GC_G(unused) = newRoot-&gt;prev;
</code></pre>

    <p>If we get back a “unused memory block” from the buffer, that means that we’ve already added and removed an item from the GC buffer. So since we have a free slot, we can just add it straight away.</p>

    <pre><code class="language-c">} else if (GC_G(first_unused) != GC_G(last_unused)) {
    newRoot = GC_G(first_unused);
    GC_G(first_unused)++;
</code></pre>

    <p>We have free space in the buffer that we haven’t used, so add it there.</p>

    <pre><code class="language-c">} else {
</code></pre>

    <p>This happens when our root buffer is full. By default, the root buffer is allocated to be <a href="http://lxr.php.net/xref/PHP_5_6/Zend/zend_gc.c#GC_ROOT_BUFFER_MAX_ENTRIES">10,000 values</a>.</p>

    <pre><code class="language-c">    if (!GC_G(gc_enabled)) {
        GC_ZVAL_SET_BLACK(zv);
        return;
</code></pre>

    <p>Well, if GC isn’t enabled, then why bother at all…</p>

    <pre><code class="language-php">    }
    zv-&gt;refcount__gc++;
</code></pre>

    <p>Remember we decremented the refcount earlier. We need to increment it here before the run, since the run will try to decrement it again.</p>

    <pre><code class="language-c">    gc_collect_cycles(TSRMLS_C);
</code></pre>

    <p>Collect the cycles to try to open up space.</p>

    <pre><code class="language-c">    zv-&gt;refcount__gc--;
</code></pre>

    <p>Restore the refcount to what it was.</p>

    <pre><code class="language-c">    newRoot = GC_G(unused);
    if (!newRoot) {
        return;
</code></pre>

    <p>So this means that our root buffer is full. Meaning that we’ve already got 10,000 values that we’re tracking as part of possible cycles. So since we have no more room, rather than re-allocating, we just return.</p>

    <pre><code class="language-c">    }
    GC_ZVAL_SET_PURPLE(zv);
    GC_G(unused) = newRoot-&gt;prev;
}
</code></pre>

    <p>This means we’ve found a spot, so we’re going to add it.</p>
  </li>
  <li>
    <p>Do some house-keeping</p>

    <pre><code class="language-c">newRoot-&gt;next = GC_G(roots).next;
newRoot-&gt;prev = &amp;GC_G(roots);
GC_G(roots).next-&gt;prev = newRoot;
GC_G(roots).next = newRoot;
    
GC_ZVAL_SET_ADDRESS(zv, newRoot);
    
newRoot-&gt;handle = 0;
newRoot-&gt;u.pz = zv;
    
GC_BENCH_INC(zval_buffered);
GC_BENCH_INC(root_buf_length);
GC_BENCH_PEAK(root_buf_peak, root_buf_length);
</code></pre>

    <p>The rest of this is just some house-keeping. Nothing really important happens here for our concerns, this is just the actual mechanics for adding the value to the root buffer.
Did you notice the problem?</p>
  </li>
</ol>

<p>If not, go back and look through the code carefully. See if you can spot it.</p>

<h2 id="what-happened-to-composer">What Happened To Composer</h2>

<p>Composer includes a <a href="http://en.wikipedia.org/wiki/Boolean_satisfiability_problem">SAT Solver</a>. Basically, it’s a graph of requirements, that it then solves by looking at combinations of dependencies that satisfy the requirements. It’s quite smart in how it does it, but it’s a lot of operations and is by no means a trivial problem.</p>

<p>But one of the ways it solves this problem is by creating objects. A lot of objects. Like an extreme amount. Potentially tens or hundreds of thousands of them. Or more. Some with circular references.</p>

<p>Now, remember how an object gets put on the root buffer. It just needs to have its refcount decremented.</p>

<p>It can happen if you unset a variable:</p>

<pre><code class="language-php">$a = $obj;
unset($a);
</code></pre>

<p>Or if you call a function:</p>

<pre><code class="language-php">function foo(StdClass $foo) {
}

foo($obj)
</code></pre>

<p>When the object is passed in, its refcount goes up. When it leaves the function, it goes down and hence gets added to the list of possible roots.</p>

<p>So objects are added to the root buffer <strong>all the time</strong>. This is quite quick under normal situations and has little to no performance impact.</p>

<p>However, there was a hint above as to the problem:</p>

<p>When the root buffer is full, it will try to run the <code>gc_collect_cycles()</code> function to free up space.</p>

<p>There is room for 10,000 entries in the root buffer.</p>

<p>That means that if you’ve got more than 10,000 objects <em>that have their refcounts decremented</em>, it will try to collect cycles every single time a new one’s refcount is decremented.</p>

<p>It’s important to make this one point clear:</p>

<p>It’s not enough to make 10k objects. You’d need to decrement <em>without collecting</em> all 10k objects. This is fairly rare.</p>

<pre><code class="language-php">$array = [];
for ($i = 0; $i &lt; 10000; $i++) {
    $array[] = new StdClass;
}
</code></pre>

<p>Would not result in any objects on the root buffer. Because the individual objects aren’t decremented (only the array is).</p>

<p>You’d need to pass every object to a function individually:</p>

<pre><code class="language-php">foreach ($array as $value) {
    doSomething($value);
}
</code></pre>

<p>This happens. A lot. But with 10k objects in a single execution (at the same time), it’s not exceptionally common. And it’s not happening in most web requests.</p>

<h2 id="the-take-away">The Take Away</h2>

<p>Don’t go adding <code>gc_disable()</code> to all of your code. What happened here is a pretty rare event. They created a ton of objects that they needed, and kept using. This triggered an edge-case situation where it kept calling the garbage collector over-and-over.</p>

<p>For Composer, disabling garbage collection prevented them from running into this situation. This helped them. But more often than not, the GC is actually quite smart. More often than not, it’ll be better for you than not running it.</p>

<p>My argument is that if you’re running into performance issues, you can try disabling garbage collection. But don’t leave it off.</p>

<p>If it makes an improvement, fix your application. There are very few problems that require creating and keeping alive 10k objects. Especially in a web request You are far more likely to be better served by an algorithm change than by just blindly disabling a system that on the whole is quite good. So fix your code, don’t just band-aid it. (SAT solving, and graphs in general are one case where you really do need that many objects).</p>

<p>This also shows that some improvement to the garbage collector can be done. Rather than running the collection cycle on every attempt to add a new root past 10k, perhaps a better algorithm could be developed. A few options:</p>

<ul>
  <li>
    <p>Exponential back-off</p>

    <p>In this case, you’d try running the collector. If it failed, you’d increment a counter.</p>

    <p>Before trying the next run, you check to see if the counter is an even power of 2. If it is, run the collector. Otherwise, skip the run.</p>

    <pre><code class="language-c"> if (0 == (GC_G(collect_counter) &amp; (GC_G(collect_counter) - 1))) {
     // only run on even-power-of-two calls, 0, 2, 4, 8, 16, etc
     zv-&gt;refcount__gc++;
     gc_collect_cycles(TSRMLS_C);
     zv-&gt;refcount__gc--;
 }
    
 newRoot = GC_G(unused);
 if (!newRoot) {
     // increase counter, as it's a failed run
     GC_G(collect_counter)++;
     return;
 }
 // reset counter to 0
 GC_G(collect_counter) = 0;
</code></pre>

    <p>This works nicely, since it will still keep trying to collect, but it will do it less and less frequently if it’s shown to not be effective.</p>

    <p>And if a collection is ever successful, it’ll run again next time it gets full (maximizes usefulness).</p>
  </li>
  <li>
    <p>Increase the buffer size on failed collect run</p>

    <p>Here, we’d re-allocate the buffer from 10k to 20k if the run failed.</p>

    <p>This can get EXTREMELY expensive for large numbers of objects, since it increases the runtime of the collector operation.</p>
  </li>
  <li>
    <p>Run the collector on a probability basis</p>

    <p>Define a config option for how often to run the collector. Similar to session garbage collection. Then if the buffer fills, only run the collector with that probability.</p>
  </li>
  <li>
    <p>Another idea?</p>
  </li>
</ul>

<p>But that’s what really happened.</p>


  	</div><div class="art-item-footer"><span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prev：<a href="/youre-doing-agile-wrong"
						 rel="prev" title="You're Doing Agile Wrong" >
						 You're Doing Agile Wrong
					</a></span>
					<span class="art-item-right">next：<a href="/security/2017/01/12/trust.html" rel="next"  title="Trust">
						Trust
					</a><i class="icon icon-chevron-thin-right"></i></span>
					
		</div></section>
	 <!--Gitalk评论start  -->
 
 <!-- Gitalk end -->

 
</article>
<script>
	window.subData = {
		title: 'What About Garbage?',
		tools: true
	}
</script>

            </div>
            <aside class='l_side'>


<section class='m_widget time'>
    <div class='header'>当前时间</div>
    <div class='content'>
        <canvas id="canvas" style="width:100%;padding: 20px;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
    </div>
</section>


<section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'> 
    <ul class="entry"> 
        
        <li><a class="flat-box" href="/search/categories/security"><div class='name'> Security</div><div class='badget'>6</div></a></li>
        
        <li><a class="flat-box" href="/search/categories/testing"><div class='name'> Testing</div><div class='badget'>1</div></a></li>
        
        <li><a class="flat-box" href="/search/categories/meta"><div class='name'> Meta</div><div class='badget'>2</div></a></li>
        
        <li><a class="flat-box" href="/search/categories/rant"><div class='name'> Rant</div><div class='badget'>2</div></a></li>
        
        <li><a class="flat-box" href="/search/categories/programming"><div class='name'> Programming</div><div class='badget'>1</div></a></li>
        
        <li><a class="flat-box" href="/search/categories/slides"><div class='name'> Slides</div><div class='badget'>4</div></a></li>
        
        <li><a class="flat-box" href="/search/categories/php"><div class='name'> PHP</div><div class='badget'>2</div></a></li>
        
        <li><a class="flat-box" href="/search/categories/process"><div class='name'> Process</div><div class='badget'>1</div></a></li>
        
        <li><a class="flat-box" href="/search/categories/update"><div class='name'> update</div><div class='badget'>2</div></a></li>
        
        <li><a class="flat-box" href="/search/categories/sdfdsfd"><div class='name'> sdfdsfd</div><div class='badget'>2</div></a></li>
        
        <li><a class="flat-box" href="/search/categories/docker"><div class='name'> docker</div><div class='badget'>2</div></a></li>
        
        <li><a class="flat-box" href="/search/categories/docker-compose"><div class='name'> docker-compose</div><div class='badget'>2</div></a></li>
        
    </ul> 
</div>
</section>


<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <div class="tags">
                
                
                
                
                
                
                



                <a href="/search/tags/php" style="font-size: 24.0px;color: rgb(0,0,0)" >PHP<span>16</span></a> <a href="/search/tags/security" style="font-size: 21.6px;color: rgb(0,0,0)" >Security<span>5</span></a> <a href="/search/tags/web-application-security-series" style="font-size: 14.4px;color: rgb(0,0,0)" >Web Application Security Series<span>2</span></a> <a href="/search/tags/best-practice" style="font-size: 16.8px;color: rgb(0,0,0)" >Best Practice<span>3</span></a> <a href="/search/tags/cryptlib" style="font-size: 12.0px;color: rgb(0,0,0)" >CryptLib<span>1</span></a> <a href="/search/tags/unit-testing" style="font-size: 12.0px;color: rgb(0,0,0)" >Unit Testing<span>1</span></a> <a href="/search/tags/xss" style="font-size: 12.0px;color: rgb(0,0,0)" >XSS<span>1</span></a> <a href="/search/tags/language-agnostic" style="font-size: 19.2px;color: rgb(0,0,0)" >Language Agnostic<span>4</span></a> <a href="/search/tags/programming" style="font-size: 21.6px;color: rgb(0,0,0)" >Programming<span>5</span></a> <a href="/search/tags/rant" style="font-size: 19.2px;color: rgb(0,0,0)" >Rant<span>4</span></a> <a href="/search/tags/learning" style="font-size: 21.6px;color: rgb(0,0,0)" >Learning<span>5</span></a> <a href="/search/tags/open-source" style="font-size: 12.0px;color: rgb(0,0,0)" >Open Source<span>1</span></a> <a href="/search/tags/open-standards" style="font-size: 12.0px;color: rgb(0,0,0)" >Open Standards<span>1</span></a> <a href="/search/tags/design-patterns" style="font-size: 12.0px;color: rgb(0,0,0)" >Design Patterns<span>1</span></a> <a href="/search/tags/generators" style="font-size: 12.0px;color: rgb(0,0,0)" >Generators<span>1</span></a> <a href="/search/tags/object-oriented-programming" style="font-size: 21.6px;color: rgb(0,0,0)" >Object Oriented Programming<span>5</span></a> <a href="/search/tags/php-internals" style="font-size: 19.2px;color: rgb(0,0,0)" >PHP-Internals<span>4</span></a> <a href="/search/tags/procedural-programming" style="font-size: 12.0px;color: rgb(0,0,0)" >Procedural Programming<span>1</span></a> <a href="/search/tags/conference" style="font-size: 19.2px;color: rgb(0,0,0)" >Conference<span>4</span></a> <a href="/search/tags/presentation" style="font-size: 19.2px;color: rgb(0,0,0)" >Presentation<span>4</span></a> <a href="/search/tags/community" style="font-size: 16.8px;color: rgb(0,0,0)" >Community<span>3</span></a> <a href="/search/tags/cryptography" style="font-size: 14.4px;color: rgb(0,0,0)" >Cryptography<span>2</span></a> <a href="/search/tags/education" style="font-size: 14.4px;color: rgb(0,0,0)" >Education<span>2</span></a> <a href="/search/tags/philosophy" style="font-size: 14.4px;color: rgb(0,0,0)" >Philosophy<span>2</span></a> <a href="/search/tags/work" style="font-size: 12.0px;color: rgb(0,0,0)" >Work<span>1</span></a> <a href="/search/tags/password-hashing" style="font-size: 12.0px;color: rgb(0,0,0)" >Password-Hashing<span>1</span></a> <a href="/search/tags/change" style="font-size: 12.0px;color: rgb(0,0,0)" >Change<span>1</span></a> <a href="/search/tags/inconsistencies" style="font-size: 12.0px;color: rgb(0,0,0)" >Inconsistencies<span>1</span></a> <a href="/search/tags/agile" style="font-size: 12.0px;color: rgb(0,0,0)" >Agile<span>1</span></a> <a href="/search/tags/scrum" style="font-size: 12.0px;color: rgb(0,0,0)" >Scrum<span>1</span></a> <a href="/search/tags/performance" style="font-size: 12.0px;color: rgb(0,0,0)" >Performance<span>1</span></a> <a href="/search/tags/thoughts" style="font-size: 12.0px;color: rgb(0,0,0)" >Thoughts<span>1</span></a> <a href="/search/tags/trust" style="font-size: 12.0px;color: rgb(0,0,0)" >Trust<span>1</span></a> <a href="/search/tags/jekyll" style="font-size: 14.4px;color: rgb(0,0,0)" >jekyll<span>2</span></a> <a href="/search/tags/update" style="font-size: 14.4px;color: rgb(0,0,0)" >update<span>2</span></a> <a href="/search/tags/docker" style="font-size: 14.4px;color: rgb(0,0,0)" >docker<span>2</span></a> <a href="/search/tags/docker-compose" style="font-size: 14.4px;color: rgb(0,0,0)" >docker-compose<span>2</span></a>

            
            <a href="/search/tags/php">PHP<span>16</span></a>
            
            <a href="/search/tags/security">Security<span>5</span></a>
            
            <a href="/search/tags/web-application-security-series">Web Application Security Series<span>2</span></a>
            
            <a href="/search/tags/best-practice">Best Practice<span>3</span></a>
            
            <a href="/search/tags/cryptlib">CryptLib<span>1</span></a>
            
            <a href="/search/tags/unit-testing">Unit Testing<span>1</span></a>
            
            <a href="/search/tags/xss">XSS<span>1</span></a>
            
            <a href="/search/tags/language-agnostic">Language Agnostic<span>4</span></a>
            
            <a href="/search/tags/programming">Programming<span>5</span></a>
            
            <a href="/search/tags/rant">Rant<span>4</span></a>
            
            <a href="/search/tags/learning">Learning<span>5</span></a>
            
            <a href="/search/tags/open-source">Open Source<span>1</span></a>
            
            <a href="/search/tags/open-standards">Open Standards<span>1</span></a>
            
            <a href="/search/tags/design-patterns">Design Patterns<span>1</span></a>
            
            <a href="/search/tags/generators">Generators<span>1</span></a>
            
            <a href="/search/tags/object-oriented-programming">Object Oriented Programming<span>5</span></a>
            
            <a href="/search/tags/php-internals">PHP-Internals<span>4</span></a>
            
            <a href="/search/tags/procedural-programming">Procedural Programming<span>1</span></a>
            
            <a href="/search/tags/conference">Conference<span>4</span></a>
            
            <a href="/search/tags/presentation">Presentation<span>4</span></a>
            
            <a href="/search/tags/community">Community<span>3</span></a>
            
            <a href="/search/tags/cryptography">Cryptography<span>2</span></a>
            
            <a href="/search/tags/education">Education<span>2</span></a>
            
            <a href="/search/tags/philosophy">Philosophy<span>2</span></a>
            
            <a href="/search/tags/work">Work<span>1</span></a>
            
            <a href="/search/tags/password-hashing">Password-Hashing<span>1</span></a>
            
            <a href="/search/tags/change">Change<span>1</span></a>
            
            <a href="/search/tags/inconsistencies">Inconsistencies<span>1</span></a>
            
            <a href="/search/tags/agile">Agile<span>1</span></a>
            
            <a href="/search/tags/scrum">Scrum<span>1</span></a>
            
            <a href="/search/tags/performance">Performance<span>1</span></a>
            
            <a href="/search/tags/thoughts">Thoughts<span>1</span></a>
            
            <a href="/search/tags/trust">Trust<span>1</span></a>
            
            <a href="/search/tags/jekyll">jekyll<span>2</span></a>
            
            <a href="/search/tags/update">update<span>2</span></a>
            
            <a href="/search/tags/docker">docker<span>2</span></a>
            
            <a href="/search/tags/docker-compose">docker-compose<span>2</span></a>
            
        </div>
    </div>
</div>
 </aside>
        </div>
    </div><footer id="footer" class="clearfix">

	<div class="social-wrapper">
  
  </div>
  
  <div>Copyright ©2011-2019 图解我的私房菜, all rights reserved.2014-12-03 00:00:00 +0000</div>

</footer>

<script src="/assets/js/jquery-1.12.4.min.js"></script> 
<script src="/assets/js/prism.js"></script>
<script src="/assets/js/topbar.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script>
    $(function() {
        function resetToDefaults() {
          topbar.config({
            autoRun      : true,
            barThickness : 3,
            barColors    : {
              '0'      : 'rgba(26,  188, 156, .9)',
              '.25'    : 'rgba(52,  152, 219, .9)',
              '.50'    : 'rgba(241, 196, 15,  .9)',
              '.75'    : 'rgba(230, 126, 34,  .9)',
              '1.0'    : 'rgba(211, 84,  0,   .9)'
            },
            shadowBlur   : 10,
            shadowColor  : 'rgba(0,   0,   0,   .6)'
          })
        }
        // Page load
        resetToDefaults()
        topbar.show()
        setTimeout(function() {
          // $('.l_body').fadeIn('slow')
          topbar.hide()
        }, 1500) 

 
    })
  </script>
  <script src="/assets/js/jquery-1.12.4.min.js"></script>
<script src="/assets/js/p/jquery.nicescroll.min.js"></script>

<script src="/assets/js/p/tocbot/tocbot.min.js"></script> 
<link rel="stylesheet" href="/assets/js/p/tocbot/tocbot.css">

<script src="/assets/js/p/backtop/backtop.js"></script> 
<link rel="stylesheet" href="/assets/js/p/backtop/back-top.css">

<script src="/assets/js/p/canvasTime.js"></script>
<script src="/assets/js/p/scrollreveal.min.js"></script>
<script src="/assets/js/search.js"></script>
<script src="/assets/js/app.js"></script>
</body>
</html>